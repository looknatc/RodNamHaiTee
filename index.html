<html ng-app="myApp" lang="en" >
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Rod Nam Hai Tee</title>
    <link rel="stylesheet" href="style.css" />
    
    <!-- jquery  -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <!-- bootstrap  -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.0-beta1/css/bootstrap-grid.min.css" integrity="sha512-QWjMsIpO5eW4+c4ASTEaZ4+eZNZ4YTtSDiu167Rq1Eqw//WlO+rXo4OvZMpyW/ykbN5LFeXmN6N416OzmWo7fA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- angular js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.8.3/angular.min.js" integrity="sha512-KZmyTq3PLx9EZl0RHShHQuXtrvdJ+m35tuOiwlcZfs/rE7NZv29ygNA8SFCkMXTnYZQK2OX0Gm2qKGfvWEtRXA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <!-- moment js -->
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.3/moment.min.js"></script>    
    <!-- chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.js" integrity="sha512-QSkVNOCYLtj73J4hbmVoOV6KVZuMluZlioC+trLpewV8qMjsWqlIQvkn1KGX2StWvPMdWGBqim1xlC8krl1EKQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <!--https://github.com/toorshia/justgage-->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.1.4/raphael-min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/justgage/1.2.9/justgage.min.js"></script>
    <!-- line chart -->
    <!-- <script src="https://cdn.anychart.com/releases/8.10.0/js/anychart-base.min.js"></script> -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.js" integrity="sha512-QSkVNOCYLtj73J4hbmVoOV6KVZuMluZlioC+trLpewV8qMjsWqlIQvkn1KGX2StWvPMdWGBqim1xlC8krl1EKQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>


  </head>


  <body ng-controller="myControl">
    <!-- Header -->
    <div class="header">

      <img src="assets/images/header-background.png" style="width: 100%" />

        <div class="menu_bar">
          <ul>
            <li><a href="">Home</a></li>
            <li><a href="#data-section">Data</a></li>
            <li><a href="#water-section">Water</a></li>
            <li><a href="#about-section">About us</a></li>
            <li><a href="">+</a></li>
          </ul>
        </div>


        <div class="text_block">
          <h1 class="title">Rod Nam Hai Tee</h1>
          <p class="description">
            Automated plant watering system is programmed using Arduino IDE
            software. Arduino microcontroller checks soil moisture level, if low,
            triggering a water pump on until sensor reaches threshold. After this,
            the system will re-check the soil moisture between periodic intervals
            to see if you need more water.
          </p>
        </div>

    </div>


    <div class="collected-data" id="data-section">
        <h1>Collected Data</h1>
        <hr style="width: 50%;">

        <div class="sensor-data">

          <!--

          <div class="light">
            <div class=" montserrat-normal-black-32px">Light</div>
            <h1 class="percent">{{light}}%</h1>
            <img
              class="image-3"
              src="https://anima-uploads.s3.amazonaws.com/projects/627a3db91996a722f08bb46f/releases/627a3dc415efe47701a15528/img/image-3@2x.png"
              />
          </div>

        -->

          <div class="data moisture">
            <div class="montserrat-normal-black-32px">Moisture</div>
            <h1 class="percent">{{humidity}}%</h1>
          </div>

          <div class="data temperature">
            <div class="montserrat-normal-black-32px">Temperature</div>
            <div ><canvas id="myChart" width="300" height="200"></canvas></div>
            <!-- <img
              class="image-2"
              src="https://anima-uploads.s3.amazonaws.com/projects/627a3db91996a722f08bb46f/releases/627a3dc415efe47701a15528/img/image-2@2x.png"
            /> -->
          </div>


          <div class="data soil-moisture">
            <div class="montserrat-normal-black-32px">Soil-moisture</div>
            <div class="gauge" id="gauge"></div>
            
          </div>

        </div>
    </div>

    <div class="watering-section" id="water-section">
      <br>
      <div class="overlap-group1">

        <h1>Watering</h1>
        <hr style="width: 50%;">
      
          <div class="overlap-group8">

            <div class="place-1 date-data">
              <h2>Date</h2>
              <!-- Add Date-->
              <div class="text-2">
                29/4/2022&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 10:00:00
              </div>

            </div>

            <div class="overlap-group7 date-data">
              <h2>Total Amount</h2>
              <div class="number">10</div>
            </div>
            

          </div>


      </div>
    </div>

    <div class="about-section">
      <div class="about">
        <h1>About us</h1>
        <hr>
        <p>Produced by เราจะรอดไปด้วยกัน</p>
      </div>
      
    </div>      

    <div id="container"></div>
    


    <script type="module" src ="index.js"></script>



<script>
angular.module('myApp', [])
.controller('myControl', function($scope) {
    $scope.temperature = "";
    $scope.humidity = "";
    $scope.light = "";
    $scope.soilHumidity = "";
    $scope.changeTenp = function(dir){
      if(dir == "up"){
        $scope.temperature += 1.0;
      }else{
        $scope.temperature -= 1.0;
      }
    }
    $scope.save = function(){
        var obj = {
          Temperature: $scope.temperature,
          humidity:  $scope.humidity,
        }
        console.log("save",obj);
    }
    $scope.round = function(num){
        return Math.round((num + Number.EPSILON) * 100) / 100
    }
    
    $scope.hourData = function(data){
        var ret = [];
        for(var i=0;i<24;i++){
            ret.push({
              label: i,
              humidity: 0,
              temperature: 0,
              light: 0,
              soilHumidity:0,
              count: 0,
            });
        }
        for(var i=0;i<data.length;i++){
            var d = data[i];
            var local = moment.utc(d.time.seconds*1000).local();
            var hour = local.hour();
            var prev = {... ret[hour]};
            var avg = {
              label: prev.label,
              humidity:$scope.round( (d.humidity + (prev.humidity * prev.count))/(prev.count + 1)),
              temperature:$scope.round( (d.temperature + (prev.temperature * prev.count))/(prev.count + 1)),
              light:$scope.round( (d.light + (prev.light * prev.count))/(prev.count + 1)),
              soilHumidity:$scope.round( (d.soilHumidity + (prev.soilHumidity * prev.count))/(prev.count + 1)),
              count: prev.count + 1,
            }
            ret[hour] = avg;
            console.log(local.format(),local.format("HH"));
        }
        console.log(ret);
        return ret;
    }
    
    $scope.loadData = async function(){
        var ret = await getAllDataByDate(2);
        ret = ret.sort(function(x, y){
            return x.time.seconds - y.time.seconds;
        })
      
        // for(var i =0;i<ret.length;i++){
        //     console.log(moment(ret[i].time.seconds*1000).format('LLL'))
        // }
        // data = [];
        // for(var i =0;i<ret.length;i++){
        //   data.push([ret[i].time.seconds*1000,ret[i].temperature]);
        //     // console.log(moment(ret[i].time.seconds*1000).format('LLL'))
        // }
        var hourData = $scope.hourData(ret);

        //         // create a data set on our data
        // var dataSet = anychart.data.set(data);

        // // map data for the line chart,
        // // take x from the zero column and value from the first column
        // var seriesData = dataSet.mapAs({ x: 0, value: 1 });

        // // create a line chart
        // var chart = anychart.line();

        // var lineChart = chart.line(seriesData);

        // // set the container id for the line chart
        // chart.container('container');

        // // draw the line chart
        // chart.draw();

        
        // console.log(ret);
        $scope.$apply(function () {
            var last = ret[ret.length -1];
            console.log("loadData",last);
            $scope.temperature = last.temperature;
            $scope.humidity = last.humidity;
            $scope.light = last.light;
            $scope.soilHumidity = last.soilHumidity;
            $scope.gauge.refresh($scope.soilHumidity/100);
            $scope.createChart(hourData);
        });
    }
    $scope.createChart = function(data){
      var labels = [];
      var temperature = [];
      var soilHumidity = [];
      var light = [];
      for(var i=0;i<data.length;i++){
          labels.push(data[i].label);
          temperature.push(data[i].temperature);
          soilHumidity.push(data[i].soilHumidity/100);
          light.push(data[i].light);
      }
      console.log(temperature,labels);
      const ctx = document.getElementById('myChart').getContext('2d');
      const myChart = new Chart(ctx, {
      type: 'line',
      data: {
          labels: labels,
          datasets: [
            {
              label: 'Temperature',
              data: temperature,
              borderColor: 'black',
              backgroundColor: 'white',
              borderWidth: 1,
            }
          ]
      },
      options: {
          scales: {
              y: {
                  beginAtZero: false,
              }
          }
      }
      });      
    }
    $scope.gauge = new JustGage({
        id: "gauge", // the id of the html element
        value: 0,
        min: 0,
        max: 100,
        decimals: 2,
        gaugeWidthScale: 0.6,
        dialStartAngle: 180,
        dialEndAngle: 0,
        labelFontColor: 'black',
    });

    $scope.loadData();

});      
    </script>
  </body>
</html>
