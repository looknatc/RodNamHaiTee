<html ng-app="myApp" lang="en" >
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Rod Nam Hai Tee</title>
    <link rel="stylesheet" href="style.css" />
    
    <!-- jquery  -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <!-- bootstrap  -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.0-beta1/css/bootstrap-grid.min.css" integrity="sha512-QWjMsIpO5eW4+c4ASTEaZ4+eZNZ4YTtSDiu167Rq1Eqw//WlO+rXo4OvZMpyW/ykbN5LFeXmN6N416OzmWo7fA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- angular js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.8.3/angular.min.js" integrity="sha512-KZmyTq3PLx9EZl0RHShHQuXtrvdJ+m35tuOiwlcZfs/rE7NZv29ygNA8SFCkMXTnYZQK2OX0Gm2qKGfvWEtRXA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <!-- moment js -->
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.3/moment.min.js"></script>    
    <!-- chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.js" integrity="sha512-QSkVNOCYLtj73J4hbmVoOV6KVZuMluZlioC+trLpewV8qMjsWqlIQvkn1KGX2StWvPMdWGBqim1xlC8krl1EKQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <style>
      .material-symbols-outlined {
        font-variation-settings:
        'FILL' 0,
        'wght' 500,
        'GRAD' 0,
        'opsz' 40
      }
      </style>
    <!--https://github.com/toorshia/justgage-->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.1.4/raphael-min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/justgage/1.2.9/justgage.min.js"></script>
    <!-- line chart -->
    <!-- <script src="https://cdn.anychart.com/releases/8.10.0/js/anychart-base.min.js"></script> -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.js" integrity="sha512-QSkVNOCYLtj73J4hbmVoOV6KVZuMluZlioC+trLpewV8qMjsWqlIQvkn1KGX2StWvPMdWGBqim1xlC8krl1EKQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
    <script src="https://code.jquery.com/ui/1.13.1/jquery-ui.js"></script>

  </head>


  <body ng-controller="myControl">
    <!-- Header -->
    <div class="header">

      <img src="assets/images/header-background.png" style="width: 100%" />

        <div class="menu_bar">
          <ul>
            <li><a href="">Home</a></li>
            <li><a href="#data-section">Data</a></li>
            <li><a href="#water-section">Water</a></li>
            <li><a href="#about-section">About us</a></li>
            <li><a href="">+</a></li>
            
          </ul>
        </div>


        <div class="text_block">
          <h1 class="title">Rod Nam Hai Tee</h1>
          <p class="description">
            Automated plant watering system is programmed using Arduino IDE
            software. Arduino microcontroller checks soil moisture level, if low,
            triggering a water pump on until sensor reaches threshold. After this,
            the system will re-check the soil moisture between periodic intervals
            to see if you need more water.
          </p>
        </div>
    </div>


    <div class="collected-data" id="data-section">
        <h1>Collected Data</h1>
        <div class="row">
            <div class="col-md-5"></div>
            <div class="col-md-2">
              <div style="text-align: center;">
                <button class="material-icon"><span ng-click="changedate(-1)" class="material-symbols-outlined">
                  chevron_left
                </span></button>
                <span style="font-size:20px;">{{selectedDate}}</span>
                <button class="material-icon"><span ng-click="changedate(1)" class="material-symbols-outlined">
                  chevron_right
                </span></button>
              </div>
            </div>
            <div class="col-md-5"></div>
        </div>
        <hr style="width: 50%;">
        <div class="sensor-data">

          <!--

          <div class="light">
            <div class=" montserrat-normal-black-32px">Light</div>
            <h1 class="percent">{{light}}%</h1>
            <img
              class="image-3"
              src="https://anima-uploads.s3.amazonaws.com/projects/627a3db91996a722f08bb46f/releases/627a3dc415efe47701a15528/img/image-3@2x.png"
              />
          </div>

        -->

          <div class="data moisture">
            <div class="montserrat-normal-black-32px">Moisture</div>
            <h1 class="percent">{{humidity}}%</h1>
          </div>

          <div class="data temperature">
            <div class="montserrat-normal-black-32px">Graph</div>
            <div ><canvas id="myChart" width="300" height="200"></canvas></div>
            <!-- <img
              class="image-2"
              src="https://anima-uploads.s3.amazonaws.com/projects/627a3db91996a722f08bb46f/releases/627a3dc415efe47701a15528/img/image-2@2x.png"
            /> -->
          </div>


          <div class="data soil-moisture">
            <div class="montserrat-normal-black-32px">Soil-moisture</div>
            <div class="gauge" id="gauge"></div>
            
          </div>

        </div>
    </div>

    <div class="watering-section" id="water-section">
      <br>
      <div class="overlap-group1">

        <h1>Watering</h1>
        <hr style="width: 50%;">
      
          <div class="overlap-group8">

            <div class="place-1 date-data">
              <h2>Date</h2>
              <!-- Add Date-->
              <div class="text-2">
                <table>
                  <tr>
                    <!-- <th>Date</th>
                    <th>Time</th>   -->
                  </tr>
                  <tr class="water-data" ng-repeat="item in waterData">
                    <td>{{moment(item.time).format('ll')}}</td>
                    <td>{{moment(item.time).format('HH:mm')}}</td>  
                  </tr>
                </table>
                <!-- 29/4/2022&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 10:00:00 -->
              </div>

            </div>

            <div class="overlap-group7 date-data">
              <h2>Total Amount</h2>
              <div class="number">{{waterData.length}}</div>
            </div>
            

          </div>


      </div>
    </div>

    <div class="about-section">
      <div class="about">
        <h1>About us</h1>
        <hr>
        <p>Produced by เราจะรอดไปด้วยกัน</p>
      </div>
      
    </div>  
    <button>click</button> 
    <p>Date: <input type="text" id="datepicker"></p>
    

    
    


    <script type="module" src ="index.js"></script>
    <script>
      var ret;
      $(document).ready(function(){
        $("button").click(function(){
          ret = $.getJSON("https://iz1mjkeoql.execute-api.us-west-1.amazonaws.com/stage/getData?id=Naotest8&from=2022-5-26")
          console.log(ret);
        });
      });
    </script>
    <script>
   
    </script>



<script>
angular.module('myApp', [])
.controller('myControl', function($scope) {
    $scope.temperature = "";
    $scope.humidity = "";
    $scope.light = "";
    $scope.soilHumidity = "";
    $scope.changeTenp = function(dir){
      if(dir == "up"){
        $scope.temperature += 1.0;
      }else{
        $scope.temperature -= 1.0;
      }
    }
    $scope.save = function(){
        var obj = {
          Temperature: $scope.temperature,
          humidity:  $scope.humidity,
        }
        console.log("save",obj);
    }
    $scope.round = function(num){
        return Math.round((num + Number.EPSILON) * 100) / 100
    }
    
    $scope.hourData = function(data){
        var ret = [];
        for(var i=0;i<24;i++){
            ret.push({
              label: i,
              humidity: 0,
              temperature: 0,
              light: 0,
              soilHumidity:0,
              count: 0,
            });
        }
        for(var i=0;i<data.length;i++){
            var d = data[i];
            var local = moment.utc(d.time).local();
            var hour = local.hour();
            var prev = {... ret[hour]};
            var avg = {
              label: prev.label,
              humidity:$scope.round( (d.humidity + (prev.humidity * prev.count))/(prev.count + 1)),
              temperature:$scope.round( (d.temperature + (prev.temperature * prev.count))/(prev.count + 1)),
              light:$scope.round( (d.light + (prev.light * prev.count))/(prev.count + 1)),
              soilHumidity:$scope.round( (d.soilHumidity + (prev.soilHumidity * prev.count))/(prev.count + 1)),
              count: prev.count + 1,
            }
            ret[hour] = avg;
            console.log(local.format(),local.format("HH"));
        }
        console.log(ret);
        return ret;
    }
    
    /*$scope.loadData = async function(){

        var ret = await getAllData("Naotest8",moment().format("YYYY-M-D"));
        if( ret.length == 0){
          return;
        }
        ret = ret.sort(function(x, y){
            return x.time.seconds - y.time.seconds;
        })
        
        // console.log("ret",ret);
        var clean = [];
        for(var i = 0;i< ret.length;i++){
          if(ret[i].temperature >10.0){
            clean.push(ret[i]);
          }
        }
        ret = clean;
        console.log("cleandata",ret);
      
        var hourData = $scope.hourData(ret);

        $scope.$apply(function () {
            var last = ret[ret.length -1];
            console.log("loadData",last);
            $scope.temperature = last.temperature;
            $scope.humidity = $scope.round(last.humidity);
            $scope.light = last.light;
            $scope.soilHumidity = last.soilHumidity;
            $scope.gauge.refresh($scope.soilHumidity);
            $scope.createChart(hourData);
        });
    }*/
    $scope.loadData = async function(){
        var ret = await getAllData($scope.id,$scope.selectedDate);
        $scope.rawData = ret;
        ret = ret.sort(function(x, y){
            return x.time.seconds - y.time.seconds;
        })

        // console.log("ret",ret);
        var clean = [];
        for(var i = 0;i< ret.length;i++){
          if(ret[i].temperature >10.0){
            clean.push(ret[i]);
          }
        }
        ret = clean;
        console.log("cleandata",ret);

        var hourData = $scope.hourData(ret);

        $scope.$apply(function () {
            if(ret.length > 0){
              var last = ret[ret.length -1];
              console.log("loadData",last);
              $scope.temperature = last.temperature;
              $scope.humidity = $scope.round(last.humidity);
              $scope.light = last.light;
              $scope.soilHumidity = last.soilHumidity;
              
            }else{
              $scope.temperature = null;
              $scope.humidity = null;
              $scope.light = null;
              $scope.soilHumidity = null;
            }
            $scope.gauge.refresh($scope.soilHumidity);
            $scope.createChart(hourData);            
        });
        $scope.loadWaterData();
    }
    $scope.moment = moment;
    /*$scope.loadWaterData = async function(){
        var ret = await getAllWaterDataByDate("Naotest8",moment().format("YYYY-M-D"));
        console.log("loadWaterData",ret);
        $scope.$apply(function () {
          $scope.waterData = ret;
        });
    }*/
    $scope.loadWaterData = async function(){
        var ret = await getAllWaterDataByDate($scope.rawData);
        console.log("loadWaterData",ret);
        $scope.$apply(function () {
          $scope.waterData = ret;
        });
    }
    $scope.pushIfValid = function(value,list){
      if(value != 0){
        list.push(value);
      }
      else{
        list.push(null);
      }
    }
    $scope.myChart = null;
    $scope.createChart = function(data){
      var labels = [];
      var temperature = [];
      var soilHumidity = [];
      var humidity = [];
      var light = [];
      for(var i=0;i<data.length;i++){
          labels.push(data[i].label);
          // temperature.push(data[i].temperature);
          // humidity.push(data[i].humidity);
          // soilHumidity.push(data[i].soilHumidity/100);
          // light.push(data[i].light);
          $scope.pushIfValid(data[i].temperature,temperature);
          $scope.pushIfValid(data[i].humidity,humidity);
          $scope.pushIfValid(data[i].soilHumidity,soilHumidity);
          $scope.pushIfValid(data[i].light,light);
      }
      console.log(temperature,labels);
      var datasets = [
              {
                label: 'Temperature',
                data: temperature,
                borderColor: 'black',
                backgroundColor: 'white',
                borderWidth: 1,
              },
              {
                label: 'soilHumidity',
                data: soilHumidity,
                borderColor: 'brown',
                backgroundColor: 'brown',
                borderWidth: 1,
              },
              {
                label: 'humidity',
                data: humidity,
                borderColor: 'green',
                backgroundColor: 'green',
                borderWidth: 1,
              },
      ];
      if($scope.myChart !=null){
        for(var i = 0;i<temperature.length;i++){
          $scope.myChart.data.datasets[0].data[i] = temperature[i];
          $scope.myChart.data.datasets[1].data[i] = soilHumidity[i];
          $scope.myChart.data.datasets[2].data[i] = humidity[i];
        }
        $scope.myChart.update();
      }else{
        const ctx = document.getElementById('myChart').getContext('2d');
        $scope.myChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: datasets,
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true,
                }
            },
        }
        });      
      }
    }
    $scope.gauge = new JustGage({
        id: "gauge", // the id of the html element
        value: 0,
        min: 0,
        max: 100,
        decimals: 2,
        color : "#fff000",
        gaugeWidthScale: 0.6,
        dialStartAngle: 180,
        dialEndAngle: 0,
        labelFontColor: 'black',
        // customSectors : [{"lo":0,"hi":10,"color":"#a9d70b"},
        //            {"lo":11,"hi":22,"color":"#f9c802"},
        //            {"lo":23,"hi":34,"color":"#ff0000"}],
    });

    $( "#datepicker" ).datepicker({
      onSelect: function(dateText) {
        console.log("Selected date: " + dateText + "; input's current value: " + this.value);
        $scope.$apply(function () {
          $scope.changedate();
        });
      }
    });
    $scope.id = "Naotest8";
    $scope.selectedDate = moment().format("YYYY-M-D");
    $scope.changedate = function(days){
        if(days == null){
          var x = $('#datepicker').val().split('/');
          $scope.selectedDate = [x[2],x[0],x[1]].join('-');
        }else{
          $scope.selectedDate = moment($scope.selectedDate).add(days, 'days').format("YYYY-M-D");
        }
        $scope.loadData();
        //$scope.loadWaterData();
    }
    // load today data
    $scope.loadData();
    //$scope.loadWaterData();
});      


    </script>
  </body>
</html>
